# Introduction
Welcome to the HHA CBR Manager project by team Saturn! 

The goal of the project is to create an Android app that satisfies the customers requirements as stated in the initial presentation and any requirements to be modified or added through feedback.


## Tools
Our development tools include using Android Studio for the frontend including all UI elements and Django as the backend server which is used to communicate with the database and handle any additional logic performed on the data.

## Progress

### Iteration 1
In iteration 1, we've designed the UI for the majority of required pages and created the classes and models for users, clients, visits and alerts. So now all users can create, store and retrieve their clients' and visits' data to and from the server, either ran locally or through the one deployed on Heroku. The admin can also send alerts to all and create new users that have seperate sets of clients and visit data.

### Iteration 2
In iteration 2, we focused on adding the ability for users to create referrals for clients, which can then be viewed and edited. Speaking of editing, this was another area we focused on this iteration. Now clients and visits can also be edited through the app as well. We also placed a search feature in a lot of the pages, which will be handy once the number of clients and visits grows. Another focus this iteration was on using a local db with syncing to allow users to use the app offline. Finally, we improved a lot of the app's UI this iteration, based on feedback from the customer, and also based on having a better understanding of the flow of the app and how to use Android at this point. One of these changes was login caching, which we feel definitely makes the app more convenient to use (and to test!).

## Upcoming
For next iteration we plan to finalize the risk algorithm, finish work on local database syncing, add the ability to easily view historical changes, and improve client goal tracking. We also will finalize the UI across the board to get everything looking and feeling as good as possible. And of course we'll make changes based on the customer's feedback of our iteration 2 demo!


# How to setup Local Development

## Django

1. Run your server at 0.0.0.0 on port 8000

   `python manage.py runserver 0.0.0.0:8000`



2. Get your local computer IP

   - Open a terminal
   - Run `ipconfig` might be different for mac `man ipconfig`?
   - Look for an `IPV4 Address` not `Default Gateway`
   - Use this address to access Django and copy this somewhere. We will need this for the Android section.

# Android

1. Head to `frontend/` and find `local.properties`

2. Add a line to the file, and place your IP you found earlier in the appropriate field

   `API_URL="http://<YOUR_IP>:8000/"`

   - quotes are important here
   - the last slash is important

3. Your file should look like this now

   ```
   sdk.dir=C\:\\Users\\tangj\\AppData\\Local\\Android\\Sdk
   API_URL="http://<YOUR_IP>:8000/"
   ```



# Done!

Now you should be able to connect to the Django API with Android.



# Directory Structure

## High Level

At the root directory there are two folders `backend` and `frontend`.

- frontend contains the source code for the Android app that act as the user interface for communicating with the backend
- backend contains the source code for the Django server that maintains the API, models, and database operations.

## Backend directory

Here we follow the standard Django folder structure that gets generated when a project gets initialized. Each component in the app gets their own folder. i.e. clients, visits, alerts ... as an application or sub application. Within each app we have definitions of models, serializers to serialize the model, and API endpoints to expose the model to operations via HTTP methods.

- models.py - where models get defined.
- views.py - where the API logic of endpoints get defined.
- serializer.py - the serializer that serializes a model.

`cbrsite` is the root app for the Django project where new apps are registered into `cbrsite/settings.py`. It also contains are `urls.py` that controls routing for the entire Django project.

`images` contains the media that gets uploaded to the server. Examples includes client and user photos.

One special addition is a `scripts` folder that contains scripts that help us with development. For example, one script generates and populates clients with random data into our database.

For dependencies, `requirements.txt` contains the needed dependencies to run the Django project.

## Frontend directory

Here we follow the standard Android folder structure that gets generated by Android studios.

For logic and the packages, we have the following organization:

- `service` package - contains all the services, and models that defines and manages requests to be sent to the backend. These services are responsible for deserializing JSON to Java objects from requests responses so we can manipulate them in the Java environment.
- `ui` package - contains our activities, fragments, and any components or logic that have to deal with the user interface. This includes our login page, client listing page, etc.
- `utils` package - contains helper and utility classes to be used through the entire Android app.

For layouts, that is `frontend\app\src\main\res\layout`, contains our UI elements. They are placed in flat folder structure and are referenced as needed.

`assets` contains our static front end assets.

`app/src/build.gradle` contains the dependencies for the application.

# Project Build Requirements

## Android Studio
1. Download the latest version of Android studio from [this link](https://developer.android.com/studio), available for Windows, Mac, Linux and Chrome OS.

2. Follow the download and installation instruction until you open Android Studio

 ![Android studio](/readme-images/build-setup01.PNG)

### Android Emulator
Android Emulator can be use on [Windows](#windows), [Mac](#mac) and [Linux](#linux)

#### Windows
1. Go to Control Panel and search `feature` on the search box.

2. Click on `Turn windows feature on/off` and make sure Hyper-V/Windows Hypervisor Platform or any other virtual machine features are unchecked

 ![unchecked](/readme-images/build-setup02.PNG)

 you will need to restart your computer.

3. If you are using AMD processor go to [this step](#amd-processor), otherwise if you are using Intel processor continue on.

##### Intel processor
1. Open Android studio and go to Configure>SDK manager>SDK Update sites

 ![SDK Update sites](/readme-images/build-setup03.PNG)

2. Select and install Intel HAXM

3. Follow the instruction, after installation you can check if it is installed correctly by typing `sc query intelhaxm` on the Window command prompt

 ![command prompt](/readme-images/build-setup04.PNG)

if you can see `STATE 4 RUNNING` it mean the installation run correctly

4. Go to [AVD Setup](#android-virtual-device-setup)

##### AMD processor
1. Open Android studio and go to Configure>SDK manager>SDK Tool

 ![SDK Tool](/readme-images/build-setup05.PNG)

2. Select and install Android Emulator Hypervisor Driver for AMD Processors.

3 Follow the instruction, after installation you can check if it is installed correctly by typing `sc query gvm` on the Window command prompt, if you can see `STATE 4 RUNNING` it means the installation run correctly.

4. Go to [AVD Setup](#android-virtual-device-setup)

#### Mac
1. On MacOS X v10.10 Yosemite or higher, Android emulator use the built-in Hypervisor.Framework, if your MacOS version is lower you can go to Android studio Configure>SDK Manager>SDK Update sites and install Intel HAXM

2. Go to [AVD Setup](#android-virtual-device-setup)
#### Linux
1. For both Intel and AMD processor you need to install KVM, first check whether kvm is already installed on your system by using cpu-checker and kvm-ok commmand, run these commands in order

 cpu-checker
 ```
 sudo apt-get install cpu-checker
 egrep -c '(vmx|svm)' /proc/cpuinfo
 ```

 kvm-ok
 ```
 kvm-ok
 ```

 Final result should show `KVM acceleration can be used`

2. If KVM is not installed on your system, run the following command
 ```
 sudo apt-get install qemu-kvm libvirt-bin ubuntu-vm-builder bridge-utils ia32-libs-multiarch
 ```

3. Go to [AVD Setup](#android-virtual-device-setup)
#### Android Virtual Device Setup
1. Go to Android studio>Configure>AVD Manager

 ![AVD Manager](/readme-images/build-setup06.PNG)

2. Create the virtual device you want to test the application on, this application is designed for Phone type android devices. API level can be as high as you want - for reference, according to April 2020 survey, over 30% of android devices use Pie API level 28 (also called Pie 9)

3. Finish the creation process and wait for download.

## Django Virtual environment
1. Download and install Python 3.9 from [this link](https://www.python.org/downloads/release/python-390/)

2. Open the project backend folder [(backend directory explanation)](#backend-directory)

3. Open a terminal or Windows Command prompt in this directory and run the following commands in order
 ```
 python -m venv venv
 For Linux: source venv/bin/activate
 For Windows: venv\Scripts\activate

 pip install django
 pip install djangorestframework
 ```

4. Follow the instruction from [How to setup local development](#how-to-setup-local-development)



## Peter's Contribution

### Dashboard (Iteration 1)

The dashboard was created with the vision of something like a newsfeed, where a user can view important information such as the alerts and statistics drawn from all sections of the app.

**User story:** As a user, I want to be able to see alerts from the dashboard, so I can priorituze clients based on urgency

**User story:** As an admin, I want to be able to view various CBR statistics, so I can monitor the CBR team's progress.
* The dashboard is split into sections: alerts, high priority clients, visits, and referrals (for the future).  The Alerts section shows the most recent alert sent by an admin. The High Priority Clients Section shows the top 5 highest risk clients, along with two buttons to view all clients and add clients.
* The Visits section show statistics about visits: total visits made, locations visited, total clients visited.


### Clients List (Iteration 1)
The clients list allows the user to quickly view basic information about all clients. If necessary, the user may select a user in order to view more specific information.

**User story:** As a user, I want to be able to search for one or some of my clients, so I can monitor and record client related activity
* The client list currently shows the profile picture, name, location, and risk rating for each client. The client and then be selected so the user may view additional details and create a visit.

### Creation of New Visits (Iteration 1)

The creation of a new visit can currently be accessed through a button found in the details of a client. The survey is compiled into one scrollable activity. Once submitted, the data is uploaded to the backend.

**User Story:** As a user, I want to be able to record and edit client/visit data, so I can better manage my duties.

The New Visit Survey follows the logic listed:
1. If CBR is not selected as a purpose, then all provision sections are visible.
2. If CBR is selected as a purpose, the provisions are hidden unless the user selects a provision to be visible using the chips.
3. Descriptions of provisions and goal conclusion descriptions are hidden unless the user selects the provision chip or selects the "goal met" radio button.

The flow of the survey is an adaptation of our Piazza post, question #47.

**Unfinished parts:**

1. Implementation of required fields is missing. User must not be able to submit a visit survey unless required fields are filled out.

### Navigation Drawer (Iteration 1)
The navigation bar acts as an index for the app, where the user can quickly jump between different sections such as client list, visit list, dashboard, and client creation.

**Unfinished parts:**
1. A logout/close button within the navigation drawer.

### User Interface Consistency (Iteration 1)

This was an additional task undertook to ensure that the interface has a consistency (such as the same font, same background colour for buttons).

**Questions for the customer:**

1. Overall, what is your impression of how the app looks? Are there any particular sections which especially do not resonate with you?
2. Regarding the colour pallette, we have chosen purple to be the app's main colour. Do you have any other colour scheme in mind?
3. We have tried to include a minimal amount of colours, leaving most of the app to be white. In terms of visuals, would you like the user interface to be more colourful? Or to have more images?
4. Are there any comparable sections in apps that you enivision this app could look like (for example, the profile section of the Facebook app, the lists of songs in the Spotify app)? This could help us to modify the interface to look more as you imagine it to look.

### New Referrals Creation 
**User story:** As a user, I want to be able to record and edit client/visit data, so I can better manage my duties

Implemented the user interface, front end logic, and referral uploading. Also ensured that the required fields are filled out.

### Search bars
**User story:** As a user, I want to be able to search for one or some of my clients, so I can monitor and record client related activity

For lists within the app, I implemented the searchview to help the user quickly find the item they are looking for.

### Client Details UI Redo
**User story:** As a user, I want to be able to view all my clients/visits, so I can monitor and record client related activity

Redid the client details UI to be more clean and consistent by removing colours, adding margins, and manipulating layouts.

### Dashboard UI Redo
**User story:** As an admin, I want to be able to view various CBR statistics, so I can monitor the CBR team's progress.

At the request of the customer, redid the UI of the dashboard to be much less cluttered by adding whitespace, removing colours, and redoing the general look.


## Andrew's Contribution

### Creation of New Users (Iteration 1)

**User story:** As an admin, I want to be able to edit all user (CBR worker, clinician) data, so I can perform management duties if input was incorrect or priorities changed

* User creation(new user registration),including making the user creation page in android and uploading the new user info to the backend.

**Unfinished parts:**

1. Implementing the different levels of permission for each type of user

### Alerts Creation, List and Details (Iteration 1)

**User story:** As a user, I want to be able to see alerts from the dashboard, so I can prioritize clients/activities based on urgency

* The alerts Object was created both in the backend and frontend, so the admin/user can broadcast alert messages to the server where other users will retrieve from.
* The alerts include a title, body and date.
* The newest alerts(currently 1) show up in the the dashboard

**Unfinished parts:**

1. Specifying which users the alert messages are desginated to. (Needs user permission)

2. Adding an urgency tag/flag and the ability to mark each message as read. (Needs local database)

### Referrals List and Details

**User story:** As a user, I want to be able to view all my clients/visits, so I can monitor and record client related activity

* Referral List to hold either referrals of a specific client or all, depending on where the list was accessed from(client details for that client, all for from dashboard/nav bar)
* Referral Details to show all fields related to a certain referral.

### Referrals Editing

**User story:** As a user, I want to be able to record and edit client/visit data, so I can better manage my duties

* Referral Editing page for editing and updating a referral's status and other info intended for update (refer to field, outcome descriptions etc.).

### Tag Filtering logic

**User story:** As a user, I want to be able to search for one or some of my clients, so I can monitor and record client related activity

* Implemented resuable filtering logic with checkboxes. Currently used for filtering outstanding referral items . If referral status is resolved then it won't show if "Outstanding" is checked. 
* It works in conjunction with the search bar that looks for matching substrings, so if either is changed the results refresh.


## Kevin's Contribution

### Client details activity

*User story:** (#5)
As a user, I want to be able to view all my clients/visits, so I can monitor and record client related activity

* Client details, listing all relevant information about the client

*User story:** (4)
As a user, I want to be able to record and edit client/visit data, so I can better manage my duties

* Button on client details page which routes to edit client form
* Button on visits list page which routes to create visit page
* Edit client form UI which allows a user to edit a client's information on their client details page
* User will be able to access their visits which correspond with the client they are viewing on the client details page by clicking a button
* User will be able to create a new visit through the client details page

**Unfinished parts: **

1. Implement the PUT request portion of where a user will be able to update client details by submitting new information to the backend
2. Implement ability to edit visit information by swiping on visit items in visit list

**Questions for the customer:**

1. On the visits page, do you want to be able to edit visits by swiping the visit items to see a menu?  Or to
 have a button on the visit details page which is accessible by tapping the visit items in the visits list

2. On the clients details page, how is the layout of the buttons at the bottom? (New visit, see visits, edit and back).
Are these too many buttons?

3. Would you prefer to have a dedicated back button integrated into each accessible part of the user interface (such as the back button on the client details page)
or are you okay with just using the back button which is supplied with Android OS?

4. Is the button size too large on the visits page?  How do you feel about the overall UI of the visits page.  Should the create button be relocated elsewhere?

5. How do you feel about the attributes which are present on the client details page?  (such as health, social, education) are there any more which you would like to add?


## Kun Hyung Park(Arthur)'s Contribution

### Creation of New Clients

**User story:**  (#4)
As an admin, I want to be able to create new clients' data, so I can track their progress and keep data as reference

* Client creation ,including making the client creation page in android and uploading the new client info to the backend.

**Iteration 2:**

### Design / Create Home page

**User story:**
   As a admin/user, I want to be directed to a home page after login, so I can have a general overview of the app and choose which task to complete.


### Visit Details Edit

**User story:**
   As a user, I want to be able to edit the visit details, so I can update new informations.

* Improved UI experience by making visit details page show only filled fields, so that the user doesn't see unnecessary blank spaces.
* Linked the visit details and visit details edit page to backend database so it properly stores and updates new data.

**Questions for the customer:**

1. Is the Homepage simple and informative enough? Is there other features or shortcuts that you would like us to add / change?


## Sean's Contribution

### Visit management/details
After a user creats a visits for clients, there needs to be a convenient way for the user to view these visits. If accessing the page from the navigation bar, all visits will be shown. Users can also see a list of visits for specific clients, and then see more details for those visits.

**User Story** (#5)
As a user, I want to be able to view all my clients/visits, So I can monitor and record client related activity

* The items in the visit list include the client's name and number
* Visits can be viewed either by client or in one big list
* The per-client visits page uses nearly all the same logic as the full visits page, but it is passed the clientID and filters by it.
* The visits details page for each visit also shows additional details

**Iteration 2:**

* The visit list now displays the date of the visit
* The visit details page now shows all the desired information with no hardcoding and writes properly to the backend database
* Reorganized the client and visit backend models so that much of the information that new visits were writing to the client model now write to the visit model
* When a health goal, education goal, or social goal is inputted in a visit, it now updates the visit's respective client and shows  this new information on the client details page
* Decoupled the per-client visit list and the general visit list so that they could be contained in one fragment

### Login page
The login page allows users to log in to reach their personalized home screen

**User Story** (#1)
As an admin, I want to be able to edit all user (CBR worker, clinician) data, so I can perform management duties if input was incorrect or priorities changed

## William Tran's Contribution

### Creation of New Clients
**User story:** (#4)
As a user, I want to be able to record my client's data to a remote server so I can manage my duties.

*Client models and image root for upload and saving client data.

**Unfinished parts:**

1. Implement search function from Backend

**Questions for the customer:**

1. If given the keyword options to search clients from the list, what kind of options would you like to for search function? For example you can search by locations, name, type of disability.
It is possible to search for multiple keywords if all of the keywords are relevant to the client's data, but it is difficult to search for client's data using keyword from the visit data.


## Vincent's Contribution

### Initial creation of user creations for the backend

**User story:**  (#1)
As an admin, I want to be able to edit all user (CBR worker, clinician) data, so I can perform management duties if input was incorrect or priorities changed

* Created the backend info for the user such that we can create or modify users in the backend. This includes a username, password, email, first name, last name

**Unfinished parts:**

1. May need to include other information associated with the user.

**Questions for the customer:**

1. Are there additional fields that you want to add to users? such as age or location?

### Optimizing and refactoring of client creation

**User story:**  (#4)
As a user, I want to be able to record and edit client/visit data, so I can better manage my duties.

* Modified the create clients page such that it uses fragments rather than activities. This would give some performance gain.

# Deployment with Docker

Use docker to deploy

## Prerequisites 

`.env.dev` used to store development secrets

```
DEBUG=1 # sets django into development mode
SECRET_KEY=foo
DB_USER=postgres
DB_PASS=postgres
DB_HOST=db
DB_PORT=5432
DB_ENGINE=django.db.backends.postgresql
DB_NAME=postgres
```

`.env.prod` used to store production secrets

```
SECRET_KEY=foo
DB_NAME=postgres
DB_USER=postgres
DB_PASS=postgres
DB_HOST=db
DB_PORT=5432
DB_ENGINE=django.db.backends.postgresql
```

Here's a list of commands to for docker-compose

```
# start production
sudo docker-compose -f docker-compose.prod.yml -p prod up -d --build

# restart production
sudo docker-compose -f docker-compose.prod.yml -p prod restart

# tear down production
sudo docker-compose -f docker-compose.prod.yml -p prod down -v

# ssh into production container
sudo docker-compose -f docker-compose.prod.yml -p prod run web bash

# start dev
sudo docker-compose -f docker-compose.yml -p dev up -d --build

# restart dev
sudo docker-compose -f docker-compose.yml -p dev restart

# tear down dev
sudo docker-compose -f docker-compose.yml -p dev down -v

# ssh into dev container
sudo docker-compose -f docker-compose.yml -p dev run web bash
```

Production will be deployed on port 80

Development will be deployed on port 8001

# How to Navigate Application

Once the app is running, you will be on the login screen. Input "user1" as the username and "password123" as the password. If you have logged in before on the same device, it may skip past this screen automatically.

<img src="/readme-images/login.png"  width="432" height="888">

After logging in, you will see the homepage. Here, you can click different icons to quickly go to their pages. The sync button will sync your local database with the global one, so that you can use the app safely without internet.

<img src="/readme-images/homepage.png"  width="432" height="888">

If you click on the dashboard, you  can view alerts, see high priority clients and visit information, and use the navigation bar to access other pages.

<img src="/readme-images/dashboard.png"  width="432" height="888">

To access the navigation bar, click on the three horizontal bars in the top left corner.

<img src="/readme-images/nav_bar.png"  width="432" height="888">

To create a new user, click on "User Creation (Admin Only)" from the navigation bar. Here, you can create a new user that can log in.

<img src="/readme-images/user_creation.png"  width="432" height="888">

To create a new alert, click on "Alert Creation (Admin Only)" from the navigation bar. Here, you can fill in the text boxes to create a new alert.

<img src="/readme-images/alert_creation.png"  width="432" height="888">

Now you can see this alert at the top of the dashboard.

<img src="/readme-images/new_alert_dash.png"  width="432" height="888">

To view all alerts, click "See More" in the alert section at the top of the dashboard.

<img src="/readme-images/alert_list.png"  width="432" height="888">

You can click on an alert from here to view more details about it.

<img src="/readme-images/new_alert_details.png"  width="432" height="888">

To view clients, click on "Client List" from the navigation bar.

<img src="/readme-images/client_list.png"  width="432" height="888">

To make it easier, you can use the search bar

<img src="/readme-images/client_search.png"  width="432" height="888">

From here, you can select a client to see more details about them.

<img src="/readme-images/client_details.png"  width="432" height="888">

You can edit a client by clicking on the edit button on the client details page.

<img src="/readme-images/edit_client.png"  width="432" height="888">

From the client details page, you can see a client's visits by clicking on "See Visits".

<img src="/readme-images/per_client_visits.png"  width="432" height="888">

You can click on any individual visit to see more visit details.

<img src="/readme-images/visit_details.png"  width="432" height="888">

You can also edit a visit by clicking on the edit button.

<img src="/readme-images/edit_visit.png"  width="432" height="888">

You can also view all visits for all clients by clicking on "Visits" on the navigation bar.

<img src="/readme-images/all_visits.png"  width="432" height="888">

You can register a new client by clicking on "New Client" from the navigation bar. This will take you to the new client page. Here, you will go through several screens of questions including some drop down menus before being able to submit the new client.

<img src="/readme-images/create_client_1.png"  width="432" height="888">

To create a visit for a client, go to that client's details page and click on "New Visit". From here, fill out the fields and select options from the drop down menu(s).

<img src="/readme-images/create_visit_1.png"  width="432" height="888">

Certain selections will prompt you with other questions. For example, if you select CBR for the "Purpose of Visit" question, you will be prompted with another "CBR Type" question.

<img src="/readme-images/create_visit_2.png"  width="432" height="888">

To create a referral for a client, go to that client's details page and click on "New Referral". From here, fill out the fields and select options from the drop down menu(s).

<img src="/readme-images/create_referral.png"  width="432" height="888">

To create a referral for a client, go to that client's details page and click on "New Referral". From here, fill out the fields and select options from the drop down menu(s).

<img src="/readme-images/all_referrals.png"  width="432" height="888">

You can toggle this page so that it only show outstanding referrals.

<img src="/readme-images/outstanding_referrals.png"  width="432" height="888">

Click on a referral to see its details.

<img src="/readme-images/referral.png"  width="432" height="888">

You can edit a referral by clicking the edit button. One major thing you might edit is to change a referral status from CREATED to RESOLVED.

<img src="/readme-images/edit_referral.png"  width="432" height="888">

Once a referral is marked RESOLVED, it will no longer show up in the outstanding toggle

<img src="/readme-images/no_outstanding_referrals.png"  width="432" height="888">

Note: you may need to use the back button built into Android devices and emulators to exit from certain pages. This is something that will be addressed in the next iteration.

<img src="/readme-images/back.png"  width="78" height="517">
